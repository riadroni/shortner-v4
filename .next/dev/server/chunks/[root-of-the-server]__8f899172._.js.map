{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Work/Shortner-updated/git/app/api/create/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\nimport path from \"path\";\nimport fs from \"fs/promises\";\n\n/**\n * Handles POST requests for creating a new shortened URL.\n */\nexport async function POST(req: NextRequest) {\n  try {\n    const usernameCookie = req.cookies.get(\"username\");\n    const username = usernameCookie?.value;\n    if (!username) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const formData = await req.formData();\n    const id = formData.get(\"id\");\n    const urlMobile = formData.get(\"urlMobile\");\n    const urlDesktop = formData.get(\"urlDesktop\");\n    const file = formData.get(\"image\");\n\n    if (\n      typeof id !== \"string\" ||\n      typeof urlMobile !== \"string\" ||\n      !(file instanceof File)\n    ) {\n      return NextResponse.json(\n        { error: \"Invalid form submission\" },\n        { status: 400 }\n      );\n    }\n\n    // ✅ 1) Save uploads OUTSIDE public/\n    const uploadsDir = path.join(process.cwd(), \"uploads\");\n    await fs.mkdir(uploadsDir, { recursive: true });\n\n    const buffer = Buffer.from(await file.arrayBuffer());\n    const originalName = file.name.replace(/\\s+/g, \"_\");\n    const timestamp = Date.now();\n    const sanitizedFileName = `${id}-${timestamp}-${originalName}`;\n    const filePath = path.join(uploadsDir, sanitizedFileName);\n    await fs.writeFile(filePath, buffer);\n\n    // ✅ 2) Store API path instead of /uploads/…\n    const imagePath = `/api/uploads/${sanitizedFileName}`;\n\n    // ---- links.json handling (unchanged) ----\n    const dataDir = path.join(process.cwd(), \"data\");\n    await fs.mkdir(dataDir, { recursive: true });\n    const dataFile = path.join(dataDir, \"links.json\");\n    let linksData: Record<string, any> = {};\n    try {\n      const json = await fs.readFile(dataFile, \"utf8\");\n      linksData = JSON.parse(json);\n    } catch {\n      linksData = {};\n    }\n\n    const hasFlatEntries = Object.values(linksData).some(\n      (v: any) => v && typeof v === \"object\" && \"id\" in v\n    );\n\n    if (hasFlatEntries) {\n      if (linksData[id]) {\n        return NextResponse.json(\n          { error: \"ID already exists\" },\n          { status: 400 }\n        );\n      }\n    } else {\n      for (const userKey of Object.keys(linksData)) {\n        const userEntries = linksData[userKey] ?? {};\n        if (userEntries && typeof userEntries === \"object\" && id in userEntries) {\n          return NextResponse.json(\n            { error: \"ID already exists\" },\n            { status: 400 }\n          );\n        }\n      }\n    }\n\n    const newEntry = {\n      id,\n      image: imagePath, // ✅ using the API URL\n      urlMobile,\n      urlDesktop: typeof urlDesktop === \"string\" ? urlDesktop : \"\",\n    };\n\n    if (hasFlatEntries) {\n      const migrated: Record<string, any> = {};\n      migrated[\"global\"] = linksData;\n      migrated[username] = { [id]: newEntry };\n      linksData = migrated;\n    } else {\n      const userMap: Record<string, any> = linksData[username] ?? {};\n      userMap[id] = newEntry;\n      linksData[username] = userMap;\n    }\n\n    await fs.writeFile(dataFile, JSON.stringify(linksData, null, 2));\n\n    const origin = req.headers.get(\"origin\") ?? \"\";\n    const shortUrl = `${origin}/${id}`;\n\n    return NextResponse.json({ link: shortUrl }, { status: 201 });\n  } catch (err) {\n    console.error(err);\n    return NextResponse.json(\n      { error: \"Internal server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAKO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,iBAAiB,IAAI,OAAO,CAAC,GAAG,CAAC;QACvC,MAAM,WAAW,gBAAgB;QACjC,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,KAAK,SAAS,GAAG,CAAC;QACxB,MAAM,YAAY,SAAS,GAAG,CAAC;QAC/B,MAAM,aAAa,SAAS,GAAG,CAAC;QAChC,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IACE,OAAO,OAAO,YACd,OAAO,cAAc,YACrB,CAAC,CAAC,gBAAgB,IAAI,GACtB;YACA,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,oCAAoC;QACpC,MAAM,aAAa,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;QAC5C,MAAM,gIAAE,CAAC,KAAK,CAAC,YAAY;YAAE,WAAW;QAAK;QAE7C,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;QACjD,MAAM,eAAe,KAAK,IAAI,CAAC,OAAO,CAAC,QAAQ;QAC/C,MAAM,YAAY,KAAK,GAAG;QAC1B,MAAM,oBAAoB,GAAG,GAAG,CAAC,EAAE,UAAU,CAAC,EAAE,cAAc;QAC9D,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,YAAY;QACvC,MAAM,gIAAE,CAAC,SAAS,CAAC,UAAU;QAE7B,4CAA4C;QAC5C,MAAM,YAAY,CAAC,aAAa,EAAE,mBAAmB;QAErD,4CAA4C;QAC5C,MAAM,UAAU,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI;QACzC,MAAM,gIAAE,CAAC,KAAK,CAAC,SAAS;YAAE,WAAW;QAAK;QAC1C,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,SAAS;QACpC,IAAI,YAAiC,CAAC;QACtC,IAAI;YACF,MAAM,OAAO,MAAM,gIAAE,CAAC,QAAQ,CAAC,UAAU;YACzC,YAAY,KAAK,KAAK,CAAC;QACzB,EAAE,OAAM;YACN,YAAY,CAAC;QACf;QAEA,MAAM,iBAAiB,OAAO,MAAM,CAAC,WAAW,IAAI,CAClD,CAAC,IAAW,KAAK,OAAO,MAAM,YAAY,QAAQ;QAGpD,IAAI,gBAAgB;YAClB,IAAI,SAAS,CAAC,GAAG,EAAE;gBACjB,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;gBAAoB,GAC7B;oBAAE,QAAQ;gBAAI;YAElB;QACF,OAAO;YACL,KAAK,MAAM,WAAW,OAAO,IAAI,CAAC,WAAY;gBAC5C,MAAM,cAAc,SAAS,CAAC,QAAQ,IAAI,CAAC;gBAC3C,IAAI,eAAe,OAAO,gBAAgB,YAAY,MAAM,aAAa;oBACvE,OAAO,gJAAY,CAAC,IAAI,CACtB;wBAAE,OAAO;oBAAoB,GAC7B;wBAAE,QAAQ;oBAAI;gBAElB;YACF;QACF;QAEA,MAAM,WAAW;YACf;YACA,OAAO;YACP;YACA,YAAY,OAAO,eAAe,WAAW,aAAa;QAC5D;QAEA,IAAI,gBAAgB;YAClB,MAAM,WAAgC,CAAC;YACvC,QAAQ,CAAC,SAAS,GAAG;YACrB,QAAQ,CAAC,SAAS,GAAG;gBAAE,CAAC,GAAG,EAAE;YAAS;YACtC,YAAY;QACd,OAAO;YACL,MAAM,UAA+B,SAAS,CAAC,SAAS,IAAI,CAAC;YAC7D,OAAO,CAAC,GAAG,GAAG;YACd,SAAS,CAAC,SAAS,GAAG;QACxB;QAEA,MAAM,gIAAE,CAAC,SAAS,CAAC,UAAU,KAAK,SAAS,CAAC,WAAW,MAAM;QAE7D,MAAM,SAAS,IAAI,OAAO,CAAC,GAAG,CAAC,aAAa;QAC5C,MAAM,WAAW,GAAG,OAAO,CAAC,EAAE,IAAI;QAElC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,MAAM;QAAS,GAAG;YAAE,QAAQ;QAAI;IAC7D,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}